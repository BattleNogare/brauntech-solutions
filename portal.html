<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>BraunTech Solutions – Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Hauptlayout -->
    <link rel="stylesheet" href="brauntech.css">
    <!-- Hintergrund / Effekte -->
    <link rel="stylesheet" href="custom.d/background.css">

    <!-- Hintergrund-JS (Punkte, Orbits, Parallax) -->
    <script src="custom.d/background.js" defer></script>

    <!-- YAML Parser (für portal.yaml) -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>

<!-- Rotierende Glow-Kreise (werden per JS gefüllt) -->
<div id="bt-glow-orbits"></div>

<!-- Random-Punkte-Layer (werden per JS gefüllt) -->
<div id="bt-points"></div>

<!-- NAVBAR wird automatisch geladen -->
<header class="bt-header" data-include="custom.d/navbar.html"></header>

<main class="bt-main">
    <div class="bt-container bt-portal">
        <h1>Portal</h1>
        <p>Sammlung hilfreicher Links, kuratiert von BraunTech Solutions.</p>

        <!-- Container, den wir per JS aus der portal.yaml füllen -->
        <div id="bt-portal-groups" class="bt-portal-groups">
            <p class="bt-portal-loading">Portal wird geladen …</p>
        </div>
    </div>
</main>

<!-- FOOTER wird automatisch geladen -->
<footer class="bt-footer" data-include="custom.d/footer.html"></footer>

<!-- ============================================
     INCLUDE-SYSTEM FÜR NAVBAR + FOOTER
=============================================== -->
<script>
document.querySelectorAll("[data-include]").forEach(async (el) => {
    const file = el.getAttribute("data-include");
    if (!file) return;

    try {
        const response = await fetch(file);
        if (!response.ok) {
            console.error("Include failed:", file, response.status);
            return;
        }
        const html = await response.text();
        el.innerHTML = html;

        // Jahr aktualisieren (falls Footer mit #bt-year geladen wurde)
        const yearSpan = el.querySelector("#bt-year");
        if (yearSpan) {
            yearSpan.textContent = new Date().getFullYear();
        }
    } catch (e) {
        console.error("Include error:", file, e);
    }
});
</script>

<!-- ============================================
     PORTAL-LOGIK: portal.yaml einlesen und Kacheln erzeugen
=============================================== -->
<script>
(function () {
    const portalContainer = document.getElementById('bt-portal-groups');
    if (!portalContainer) return;

    // Hilfsfunktion: eine Kachel erzeugen
    function createTile(tile) {
        const a = document.createElement('a');
        a.className = 'bt-portal-tile';
        a.href = tile.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';

        // Hintergrund aus zwei Farben -> Gradient
        if (tile.colorStart && tile.colorEnd) {
            a.style.backgroundImage = `linear-gradient(135deg, ${tile.colorStart}, ${tile.colorEnd})`;
        }

        // Logo
        if (tile.logo) {
            const img = document.createElement('img');
            img.className = 'bt-portal-tile-logo';
            img.src = 'bilder/' + tile.logo;
            img.alt = tile.label || '';
            a.appendChild(img);
        }

        // Text / Bezeichnung
        const label = document.createElement('div');
        label.className = 'bt-portal-tile-label';
        label.textContent = tile.label || '';
        a.appendChild(label);

        return a;
    }

    // Hilfsfunktion: Gruppe erzeugen
    function createGroup(group) {
        const groupEl = document.createElement('section');
        groupEl.className = 'bt-portal-group';

        if (group.title) {
            const h2 = document.createElement('h2');
            h2.className = 'bt-portal-group-title';
            h2.textContent = group.title;
            groupEl.appendChild(h2);
        }

        const grid = document.createElement('div');
        grid.className = 'bt-portal-grid';

        (group.tiles || []).forEach(tile => {
            grid.appendChild(createTile(tile));
        });

        groupEl.appendChild(grid);
        return groupEl;
    }

    function showError(msg) {
        portalContainer.innerHTML = '';
        const p = document.createElement('p');
        p.className = 'bt-portal-error';
        p.textContent = msg;
        portalContainer.appendChild(p);
    }

    // YAML-Konfigurationsdatei laden
    fetch('custom.d/portal.yaml')
        .then(resp => {
            if (!resp.ok) {
                throw new Error('HTTP ' + resp.status);
            }
            return resp.text(); // YAML als Text laden
        })
        .then(text => {
            let data;
            try {
                data = jsyaml.load(text); // YAML -> JS-Objekt
            } catch (e) {
                console.error('YAML-Parsing-Fehler:', e);
                showError('Portal-Konfiguration ist fehlerhaft (YAML).');
                return;
            }

            portalContainer.innerHTML = '';

            if (!data || !Array.isArray(data.groups) || data.groups.length === 0) {
                showError('Keine Portaleinträge konfiguriert.');
                return;
            }

            data.groups.forEach(group => {
                portalContainer.appendChild(createGroup(group));
            });
        })
        .catch(err => {
            console.error('Fehler beim Laden der Portal-Konfiguration:', err);
            showError('Portal-Konfiguration konnte nicht geladen werden.');
        });

})();
</script>

</body>
</html>
